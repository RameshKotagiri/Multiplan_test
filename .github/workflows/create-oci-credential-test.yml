name: Create Dummy OCI Credential in Jenkins

on:
  workflow_dispatch:

jobs:
  create-oci-credential:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get Jenkins CSRF Crumb
        id: crumb
        env:
          JENKINS_URL: ${{ secrets.JENKINS_URL }}
          JENKINS_USER: ${{ secrets.JENKINS_USER }}
          JENKINS_API_TOKEN: ${{ secrets.JENKINS_API_TOKEN }}
        run: |
          echo "ðŸ” Fetching Jenkins crumb..."
          curl -s -u "$JENKINS_USER:$JENKINS_API_TOKEN" "$JENKINS_URL/crumbIssuer/api/json" > crumb.json
          echo "crumb_field=$(jq -r .crumbRequestField crumb.json)" >> $GITHUB_OUTPUT
          echo "crumb_value=$(jq -r .crumb crumb.json)" >> $GITHUB_OUTPUT

      - name: Create dummy OCI credential in Jenkins
        env:
          JENKINS_URL: ${{ secrets.JENKINS_URL }}
          JENKINS_USER: ${{ secrets.JENKINS_USER }}
          JENKINS_API_TOKEN: ${{ secrets.JENKINS_API_TOKEN }}
          CRUMB_FIELD: ${{ steps.crumb.outputs.crumb_field }}
          CRUMB_VALUE: ${{ steps.crumb.outputs.crumb_value }}
        run: |
          echo "ðŸ›  Creating dummy OCI credential..."

          cat <<EOF > payload.json
          {
            "": "0",
            "credentials": {
              "scope": "GLOBAL",
              "id": "oci-test-cred",
              "description": "Test OCI credential from GitHub Actions",
              "fingerprint": "aa:bb:cc:dd:ee",
              "privateKey": "-----BEGIN PRIVATE KEY-----\\nDUMMYKEYDATA\\n-----END PRIVATE KEY-----",
              "tenantId": "ocid1.tenancy.oc1..dummytenancy",
              "userId": "ocid1.user.oc1..dummyuser",
              "region": "us-phoenix-1",
              "passPhrase": "",
              "useInstancePrincipal": false,
              "$class": "com.oracle.cloud.baremetal.jenkins.credentials.BaremetalCloudCredentialsImpl"
            }
          }
          EOF

          curl -X POST "$JENKINS_URL/credentials/store/system/domain/_/createCredentials" \
            -u "$JENKINS_USER:$JENKINS_API_TOKEN" \
            -H "Content-Type: application/json" \
            -H "$CRUMB_FIELD: $CRUMB_VALUE" \
            -d @payload.json
